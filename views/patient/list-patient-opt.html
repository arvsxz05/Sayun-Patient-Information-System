<div class="row" id="list-opt-view">
    <div class="table-responsive">
        <h3>Out-Patient Treatment List</h3>
        <table id="opt-list" class="table table-striped table-bordered" cellspacing="0" width="100%">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Hospital</th>
                    <th>Doctor</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>

    <div class="button-group">
        <a class="btn btn-lime pull-right" type="button" onclick="add_OPT()">Add</a>    
    </div>
</div>


<script type="text/javascript">
    function edit_OPT(key){
        $('#list-opt-view').hide();
        $('#add-opt-view').hide();
        $('#edit-opt-view').show();
        $('#list-opt-view-link').show();

        $.ajax({
            type: "GET",
            url: "/opt_edit_json/"+key+"/"+"{{patient.id}}",
        }).done(function(data){
            var date;

            if(data['opt']['date'] != null){
                console.log("IN HERE EDIT OPT DATE");
                date = data['opt']['date'].split("-");
                $("#edit-opt-date-div select[name='date_[month]']").val(date[1]);
                $("#edit-opt-date-div select[name='date_[day]']").val(date[2]);
                $("#edit-opt-date-div select[name='date_[year]']").val(date[0]);
            }

            $('#edit-opt-hospital option[value="' + data['opt']['parent_record.hospitalName'] + '"]').prop('selected', 'true');

            $('#edit-opt-doctor option[value="' + data['opt']['parent_record.doctor.id'] + '"]').prop('selected', 'true');

            $('#edit-opt-summary').val(data['opt']['sum_of_diag']);
            $('#edit-opt-detailed-diagnosis').val(data['opt']['detailed_diag']);
            $('#edit-opt-notes').val(data['opt']['notes']);

            $('#edit-p-id').val(data['opt']['id']);
            $('#edit-c-id').val(data['opt']['parent_record.id']);
            
        });


    }

    function add_OPT() {
        $('#list-opt-view').hide();
        $('#add-opt-view').show();
        $('#edit-opt-view').hide();
        $('#list-opt-view-link').show();
        // dapat on-Submit nani sa ADD IPT Record//
        $('#add-opt-view select').val("");
        $('#add-opt-view input').not('#opt-doctor').not('#p-id').val("");
        $('#add-opt-view textarea').val("");


        if( $.fn.dataTable.isDataTable('#opt-list-medication') ){
            meds.rows().remove();
            med_procedures.rows().remove();
        }
        else{
            meds = $('#opt-list-medication').DataTable({
                "bSort": true, 
                "aaSorting": [[0]],
                "aoColumns": [
                    { "bSortable": false },
                    { "bSortable": true },
                    { "bSortable": true },
                    { "bSortable": true },
                    { "bSortable": true },
                    { "bSortable": true }
                ]    
            }).on('click', 'tbody tr', function () {
                var data = meds.row(this).data();
                // console.log($(this));
                edit_med_caller = $(this);

                $('#edit-medication-modal').modal('toggle');
                $('#edit-med-name').val(data[1].substring(3, data[1].length-4));
                $('#edit-med-dosage').val(data[2]);
                $('#edit-med-frequency').val(data[3]);
                $('#edit-med-type').val(data[4]);
                $('#edit-med-instructions').val(data[5]);
            });

            med_procedures = $('#opt-list-med-procedure').DataTable({
                "bSort": true, 
                "aaSorting": [[0]],
                "aoColumns": [
                    { "bSortable": false },
                    { "bSortable": true },
                    { "bSortable": true },
                    { "bSortable": true }
                ]    
            }).on('click', 'tbody tr', function () {
                var data = med_procedures.row(this).data();
                // console.log($(this));
                edit_med_procedure_caller = $(this);
                
                $('#edit-med-procedure-modal').modal('toggle');
                $('#edit-med-procedure-date select[name="date_[month]"').val(data[1].substring(3, data[1].length-4).substring(5, 7));
                $('#edit-med-procedure-date select[name="date_[day]"').val(data[1].substring(3, data[1].length-4).substring(8, 10));
                $('#edit-med-procedure-date select[name="date_[year]"').val(data[1].substring(3, data[1].length-4).substring(0, 4));
                $('#edit-med-procedure-description').val(data[2]);
                $('#edit-med-procedure-details').val(data[3]);
            });
            // 
        }
    }

</script>