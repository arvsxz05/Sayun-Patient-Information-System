<!-- IPT TABLE -->
<div class="row" id="list-ipt-view">
    <div class="table-responsive">
        <h3>In-Patient Treatment List</h3>
        <table id="ipt-list" class="table table-striped table-bordered" cellspacing="0" width="100%">
            <thead>
                <tr>
                    <!-- <th><input type="checkbox" aria-label="..." id="select-all"/></th> -->
                    <th>Confinement Date</th>
                    <th>Discharge Date</th>
                    <th>Hospital</th>
                    <th>Doctor</th>
                    <!-- <th></th> -->
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>

    <div class="button-group">
        <a class="btn btn-lime pull-right" type="button" onclick="add_IPT()">Add</a>    
    </div>
</div>
<!-- END OF IPT TABLE -->


<script type="text/javascript">

    var edit_med_caller;
    var edit_med_procedure_caller;

    function add_IPT() {
        $('#list-ipt-view').hide();
        $('#add-ipt-view').show();
        $('#edit-ipt-view').hide();
        $('#list-ipt-view-link').show();
        // dapat on-Submit nani sa ADD IPT Record//


        $('#add-ipt-view select').val("");
        $('#add-ipt-view input').not('#doctor').not('#hidden-doctor').not('#p-id').val("");
        $('#add-ipt-view textarea').val("");

        if( $.fn.dataTable.isDataTable('#list-medication') ){
            meds.rows().remove();
            med_procedures.rows().remove();
        }
        else{
            meds = $('#list-medication').DataTable({
                "bSort": true, 
                "aaSorting": [],
                "aoColumns": [
                    { "bSortable": false },
                    { "bSortable": true },
                    { "bSortable": true },
                    { "bSortable": true },
                    { "bSortable": true },
                    { "bSortable": true }
                ]    
            }).on('click', 'tbody tr', function () {
                var data = meds.row(this).data();
                // console.log($(this));
                edit_med_caller = $(this);

                $('#edit-medication-modal').modal('toggle');
                $('#edit-med-name').val(data[1].substring(3, data[1].length-4));
                $('#edit-med-dosage').val(data[2]);
                $('#edit-med-frequency').val(data[3]);
                $('#edit-med-type').val(data[4]);
                $('#edit-med-instructions').val(data[5]);
            });

            med_procedures = $('#list-med-procedure').DataTable({
                "bSort": true, 
                "aaSorting": [[0]],
                "aoColumns": [
                    { "bSortable": false },
                    { "bSortable": true },
                    { "bSortable": true },
                    { "bSortable": true }
                ]    
            }).on('click', 'tbody tr', function () {
                var data = med_procedures.row(this).data();
                // console.log($(this));
                edit_med_procedure_caller = $(this);
                
                $('#edit-med-procedure-modal').modal('toggle');
                $('#edited-med-procedure-date').val(data[1].substring(3, data[1].length-4));
                $('#edit-med-procedure-description').val(data[2]);
                $('#edit-med-procedure-details').val(data[3]);
            });

        }
        
    }

    function edit_IPT(key){
        $('#list-ipt-view').hide();
        $('#add-ipt-view').hide();
        $('#edit-ipt-view').show();
        $('#list-ipt-view-link').show();

        meds = $('#edit-list-medication').DataTable({
            "bSort": true, 
            "aaSorting": [[0]],
            "aoColumns": [
                { "bSortable": false },
                { "bSortable": true },
                { "bSortable": true },
                { "bSortable": true },
                { "bSortable": true },
                { "bSortable": true }
            ]    
        });

        med_procedures = $('#edit-list-med-procedure').DataTable({
            "bSort": true, 
            "aaSorting": [[0]],
            "aoColumns": [
                { "bSortable": false },
                { "bSortable": true },
                { "bSortable": true },
                { "bSortable": true }
            ]    
        });

        // var key = $("#edit_ipt").attr('value');
        // console.log(key);
        $.ajax({
            type: "GET",
            url: "/ipt_edit_json/"+key+"/"+"{{patient.id}}",
        }).done(function(data){
            console.log("IN HERE DONE AJAX")
            console.log(data);
            var date;
            $('#edit-p-id').val(key);

            if(data['ipt']['conf_date'] != null){
                date = data['ipt']['conf_date'].split("-");
                $("#edit-confinement-date-div select[name='date_[month]']").val(date[1]);
                $("#edit-confinement-date-div select[name='date_[day]']").val(date[2]);
                $("#edit-confinement-date-div select[name='date_[year]']").val(date[0]);
            }
            if(data['ipt']['discharge_date'] != null){
                date = data['ipt']['discharge_date'].split("-");
                $("#edit-discharge-date-div select[name='date_[month]']").val(date[1]);
                $("#edit-discharge-date-div select[name='date_[day]']").val(date[2]);
                $("#edit-discharge-date-div select[name='date_[year]']").val(date[0]);
            }

            $('#edit-summary').val(data['ipt']['sum_of_diag']);
            $('#edit-detailed-diagnosis').val(data['ipt']['detailed_diag']);
            $('#edit-notes').val(data['ipt']['notes']);
            $('#edit-hospital option[value="' + data['ipt']['parent_record.hospitalName'] + '"]').prop('selected', 'true');
            $('#edit-doctor option[value="' + data['ipt']['parent_record.doctor.id'] + '"]').prop('selected', 'true');



            $('#edit-p-id').val(data['ipt']['id']);
            $('#edit-c-id').val(data['ipt']['parent_record.id']);

            // console.log(data);

            // $('#edit-ipt-form').attr('action', '/ipt_edit/'+data['ipt']['id']+"/"+data['ipt']['check_upId']);
            
        })
    }
</script>
